<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Strom-Dashboard</title>
  <style>
    :root {
      --bg-light: #ffffff;
      --bg-dark: #121212;
      --text-light: #000000;
      --text-dark: #f0f0f0;
      --blue: #005e6e;
      --neonyellow: #a6ff00;
      --card-bg-light: #f5f5f5;
      --card-bg-dark: #1e1e1e;
      --button-bg: #007bff;
      --button-hover-bg: #0056b3;
      --button-text: #ffffff;
    }

    @media (prefers-color-scheme: dark) {
      body {
        background-color: var(--bg-dark);
        color: var(--text-dark);
      }
      .card {
        background-color: var(--card-bg-dark);
      }
    }

    @media (prefers-color-scheme: light) {
      body {
        background-color: var(--bg-light);
        color: var(--text-light);
      }
      .card {
        background-color: var(--card-bg-light);
      }
    }

    @media (max-width: 768px) {
      .card {
        padding: 1rem; /* Weniger Padding für kleinere Bildschirme */
      }
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
    }

    .card {
      border-radius: 1rem;
      padding: 1.5rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      transition: transform 0.2s;
      height: auto; /* Automatische Höhe basierend auf dem Inhalt */
    }

    .card:hover {
      transform: translateY(-4px);
    }

    .value {
      font-size: 2rem;
      font-weight: bold;
    }

    .label {
      font-size: 1rem;
      color: var(--blue);
    }

    canvas {
      width: 100% !important;
      height: auto !important;
    }

    .tab {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .tab button {
      background-color: var(--button-bg);
      color: var(--button-text);
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 0.5rem;
      font-size: 1rem;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    .tab button:hover {
      background-color: var(--button-hover-bg);
    }

    .tab button.active {
      background-color: var(--button-hover-bg);
      font-weight: bold;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    input[type="date"] {
      font-size: 1.2rem; /* Größere Schriftgröße */
      padding: 0.5rem 1rem; /* Mehr Innenabstand */
      width: 100%; /* Volle Breite innerhalb der Karte */
      max-width: 300px; /* Optionale maximale Breite */
      border: 1px solid #ccc; /* Rahmen für bessere Sichtbarkeit */
      border-radius: 0.5rem; /* Abgerundete Ecken */
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* Leichter Schatten */
    }
  </style>
</head>
<body>
  <h1>⚡ Strom-Dashboard</h1>
  <div class="tab">
    <button id="dashboard-tab" class="active" onclick="showTab('dashboard', this)">Dashboard</button>
    <button id="tagesdaten-tab" onclick="showTab('tagesdaten', this)">Tagesdaten</button>
    <button id="wochenstatistik-tab" onclick="showTab('wochenstatistik', this)">Wochenstatistik</button>
  </div>

  <!-- Dashboard Tab -->
  <div id="dashboard" class="tab-content active">
    <div class="grid">
      <div class="card">
        <div class="label">Momentanverbrauch</div>
        <div class="value" id="leistung">-- W</div>
        <canvas id="gauge"></canvas>
      </div>
      <div class="card">
        <div class="label">Bezug</div>
        <div class="value" id="bezug">-- kWh</div>
      </div>
      <div class="card">
        <div class="label">Einspeisung</div>
        <div class="value" id="einspeisung">-- kWh</div>
      </div>
      <div class="card">
        <div class="label">Tagesverbrauch heute</div>
        <div class="value" id="verbrauchHeute">-- kWh</div>
      </div>
      <div class="card">
        <div class="label">Tagesverbrauch gestern</div>
        <div class="value" id="verbrauchGestern">-- kWh</div>
      </div>
      <div class="card" style="grid-column: 1 / -1">
        <div class="label">Tagesverlauf</div>
        <canvas id="verlauf"></canvas>
      </div>
    </div>
  </div>

  <!-- Tagesdaten Tab -->
  <div id="tagesdaten" class="tab-content">
    <div class="card">
      <div class="label">Datum auswählen</div>
      <input type="date" id="datum-auswahl" onchange="fetchTagesdaten()" />
    </div>
    <div class="card">
      <div class="label">Tagesverbrauch gesamt</div>
      <div class="value" id="tagesverbrauch">-- kWh</div>
    </div>
    <div class="card">
      <div class="label">Tagesendstand</div>
      <div class="value" id="tagesendstand">-- kWh</div>
    </div>
    <div class="card" style="grid-column: 1 / -1">
      <div class="label">Tagesverlauf</div>
      <canvas id="tagesverlauf"></canvas>
    </div>
  </div>

  <!-- Wochenstatistik Tab -->
  <div id="wochenstatistik" class="tab-content">
    <div class="card">
      <div class="label">Datum auswählen</div>
      <input type="date" id="wochenstatistik-datum" onchange="fetchWochenstatistik()" />
    </div>
    <div class="card" style="grid-column: 1 / -1">
      <div class="label">Wochenstatistik</div>
      <canvas id="wochenstatistik-chart"></canvas>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    let tagesverlaufChart; // Variable für das Tagesverlauf-Diagramm
    let wochenstatistikChart; // Variable für das Wochenstatistik-Diagramm

    function formatDatum(date) {
      return date.toISOString().split("T")[0];
    }

    function berechneVerbrauch(daten) {
      if (daten.length < 2) return 0;
      return +(daten[daten.length - 1].bezug - daten[0].bezug).toFixed(2);
    }

    function aktualisiereAnzeige(aktuell) {
      document.getElementById("leistung").textContent = `${aktuell.leistung || '--'} W`;
      document.getElementById("bezug").textContent = `${(aktuell.bezug || 0).toFixed(2)} kWh`;
      document.getElementById("einspeisung").textContent = `${(aktuell.einspeisung || 0).toFixed(2)} kWh`;
      document.getElementById("verbrauchHeute").textContent = `${(aktuell.verbrauchHeute || 0).toFixed(2)} kWh`;
      document.getElementById("verbrauchGestern").textContent = `${(aktuell.verbrauchGestern || 0).toFixed(2)} kWh`;
    }

    function renderGauge(wert) {
      const ctx = document.getElementById("gauge").getContext("2d");

      // Falls das Gauge bereits existiert, zerstöre es, um es neu zu rendern
      if (window.gaugeChart) {
        window.gaugeChart.destroy();
      }

      // Neues Gauge-Diagramm erstellen
      window.gaugeChart = new Chart(ctx, {
        type: "doughnut",
        data: {
          labels: ["Verbrauch", "Rest"],
          datasets: [{
            data: [wert, 5000 - wert], // Wert und Restkapazität
            backgroundColor: ["#fffb00", "#444"], // Farben für Verbrauch und Rest
            borderWidth: 0
          }]
        },
        options: {
          cutout: "80%", // Innerer Kreis
          rotation: -90, // Startwinkel
          circumference: 180, // Halbkreis
          plugins: {
            legend: { display: false } // Keine Legende anzeigen
          }
        }
      });
    }

    function renderVerlauf(daten) {
      if (!daten || daten.length === 0) {
        console.error('Keine Daten für den Tagesverlauf verfügbar.');
        return;
      }
      const labels = daten.map(e => new Date(e.timestamp).toLocaleTimeString());
      const werte = daten.map(e => e.leistung);
      new Chart(document.getElementById("verlauf"), {
        type: "line",
        data: {
          labels,
          datasets: [{
            label: "Leistung [W]",
            data: werte,
            borderColor: "#00aaff",
            fill: false
          }]
        },
        options: { scales: { x: { ticks: { autoSkip: true, maxTicksLimit: 10 } } } }
      });
    }

    async function fetchDashboardData() {
      try {
        const response = await fetch('/api/dashboard');
        const data = await response.json();

        // Dashboard-Daten aktualisieren
        aktualisiereAnzeige(data);

        // Gauge-Diagramm rendern
        renderGauge(data.leistung || 0); // Falls kein Wert vorhanden ist, Standardwert 0

        // Letzte Aktualisierung anzeigen
        const now = new Date();
        document.getElementById('last-update-text').textContent = `Letzte Aktualisierung: ${now.toLocaleString()}`;
      } catch (error) {
        console.error('Fehler beim Abrufen der Dashboard-Daten:', error);
      }
    }

    async function fetchTagesverlauf() {
      try {
        const response = await fetch('/api/tagesverlauf');
        const verlaufData = await response.json();
        renderVerlauf(verlaufData);
      } catch (error) {
        console.error('Fehler beim Abrufen des Tagesverlaufs:', error);
      }
    }

    async function fetchWochenstatistik() {
      const datum = document.getElementById('wochenstatistik-datum').value;
      if (!datum) return;

      try {
        const response = await fetch(`/api/wochenstatistik?datum=${datum}`);
        const data = await response.json();

        const labels = data.map(entry => entry.datum);
        const values = data.map(entry => entry.verbrauch);

        const ctx = document.getElementById('wochenstatistik-chart').getContext('2d');

        // Falls das Diagramm bereits existiert, zerstöre es
        if (wochenstatistikChart) {
          wochenstatistikChart.destroy();
        }

        // Neues Diagramm erstellen
        wochenstatistikChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels,
            datasets: [{
              label: 'Tagesverbrauch (kWh)',
              data: values,
              backgroundColor: 'rgba(40, 167, 69, 0.2)',
              borderColor: 'rgba(40, 167, 69, 1)',
              borderWidth: 1,
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                display: true,
                position: 'top',
              }
            },
            scales: {
              x: {
                title: {
                  display: true,
                  text: 'Datum'
                }
              },
              y: {
                title: {
                  display: true,
                  text: 'Verbrauch (kWh)'
                },
                beginAtZero: true
              }
            }
          }
        });
      } catch (error) {
        console.error('Fehler beim Abrufen der Wochenstatistik:', error);
      }
    }

    async function fetchTagesdaten() {
      const datum = document.getElementById('datum-auswahl').value;
      if (!datum) return;

      try {
        const response = await fetch(`/api/tagesdaten?datum=${datum}`);
        const data = await response.json();

        // Tagesverbrauch und Endstand aktualisieren
        document.getElementById('tagesverbrauch').textContent = `${data.verbrauch.toFixed(2)} kWh`;
        document.getElementById('tagesendstand').textContent = `${data.endstand.toFixed(2)} kWh`;

        // Tagesverlauf-Diagramm aktualisieren
        const labels = data.verlauf.map(e => new Date(e.timestamp).toLocaleTimeString());
        const werte = data.verlauf.map(e => e.leistung);

        const ctx = document.getElementById('tagesverlauf').getContext('2d');

        // Falls das Diagramm bereits existiert, zerstöre es
        if (tagesverlaufChart) {
          tagesverlaufChart.destroy();
        }

        // Neues Diagramm erstellen
        tagesverlaufChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets: [{
              label: 'Leistung [W]',
              data: werte,
              borderColor: '#00aaff',
              fill: false
            }]
          }
        });
      } catch (error) {
        console.error('Fehler beim Abrufen der Tagesdaten:', error);
      }
    }

    function showTab(tabId, button) {
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      document.getElementById(tabId).classList.add('active');

      document.querySelectorAll('.tab button').forEach(btn => {
        btn.classList.remove('active');
      });
      button.classList.add('active');
    }

    // Daten beim Laden der Seite abrufen
    fetchDashboardData();
    fetchTagesverlauf();

    // Daten alle 60 Sekunden aktualisieren
    setInterval(fetchDashboardData, 60000);
  </script>
</body>
</html>
